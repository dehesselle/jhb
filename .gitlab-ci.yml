# SPDX-FileCopyrightText: 2022 Ren√© de Hesselle <dehesselle@web.de>
#
# SPDX-License-Identifier: GPL-2.0-or-later

variables:
  GIT_DEPTH: 1
  GIT_SUBMODULE_STRATEGY: recursive
  WRK_DIR: /Users/Shared/work
  CCACHE_DIR: /Users/Shared/work/ccache

stages:
  - build
  - release

include:
  - remote: https://raw.githubusercontent.com/dehesselle/sdkchecksum/master/.gitlab-ci/verify_sdk-template.yml

#------------------------------------------------------------------------- build

build:
  stage: build
  parallel:
    matrix:
      - RUNNER: [ "macosintel", "macosarm" ]
  rules:
    - if: $RUNNER == "macosintel"
      variables:
        SDKROOT: /opt/sdks/MacOSX10.13.4.sdk
    - if: $RUNNER == "macosarm"
      variables:
        SDKROOT: /opt/sdks/MacOSX11.3.sdk
  tags:
    - ${RUNNER}
  script:
    - !reference [ .verify_sdk, script ]
    - usr/bin/bootstrap
    - |
      source etc/jhb.conf.sh
      find "$SRC_DIR" -mindepth 1 -maxdepth 1 -type d ! -name bash_d ! -name "jhb*" -exec rm -rf {} \;
      rm -rf "$VAR_DIR"/build/*
      rm -rf "$VAR_DIR"/cache/pip/*
      rm -rf "$VAR_DIR"/cache/pycache/*
      rm -rf "${TMP_DIR:?}"/*
    - usr/bin/archive create_tar
  after_script:
    # For persistent runners: cleanup afterwards.
    - source etc/jhb.conf.sh
    - rm -rf $VER_DIR
  artifacts:
    paths:
      - jhb-*.tar.xz

#----------------------------------------------------------------------- release

release:
  stage: release
  only:
    - tags
  image: python:3-alpine
  script:
    - pip3 install gitlab-release==5.6
    - gitlab-release jhb-*.tar.xz
